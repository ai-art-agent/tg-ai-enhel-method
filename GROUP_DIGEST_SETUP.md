# Пошаговая настройка дайджеста по групповым занятиям

Ниже — что сделать по шагам, чтобы уведомления об оплатах групповых занятий заработали в выбранном режиме.

---

## Шаг 0. Решите, какой режим вам нужен

- **Сразу при каждой оплате** — в чат приходит одна строка сразу после того, как Робокасса подтвердила платёж. Cron не нужен.
- **По расписанию (1–3 раза в сутки)** — в чат приходит одна сводка (таблица) в заданные часы. Нужен cron на сервере.

Дальше настраиваем под выбранный режим.

---

## Часть A. Режим «сразу» (immediate)

### A.1. Узнать chat_id чата или использовать @username

1. **Вариант 1 — число (личный чат или группа):** создайте группу в Telegram или выберите личный чат. Добавьте в группу бота. Напишите в чат любое сообщение, откройте в браузере:  
   `https://api.telegram.org/bot<ВАШ_ТОКЕН>/getUpdates`  
   В ответе найдите `"chat":{"id": -123456789}` или `"chat":{"id": 123456789}` — число `id` и есть chat_id.

2. **Вариант 2 — @username канала:** можно указать имя канала в формате `@channelname` (например `@cogito163`). В этом случае бот будет слать уведомления в канал (бот должен быть администратором канала).

### A.2. Прописать переменные в .env

Откройте файл **`.env`** в папке с ботом (на компьютере или на ВМ — там, где запущен бот и сервер Robokassa).

Убедитесь, что есть строка (если нет — добавьте, подставьте свой chat_id **или** @username канала):

```env
TELEGRAM_GROUP_NOTIFY_CHAT_ID=-123456789
```
или для канала:
```env
TELEGRAM_GROUP_NOTIFY_CHAT_ID=@cogito163
```

Добавьте или измените строку:

```env
GROUP_DIGEST_MODE=immediate
```

Остальные переменные `GROUP_DIGEST_TIME_1`, `GROUP_DIGEST_TIME_2`, `GROUP_DIGEST_TIME_3` и `GROUP_DIGEST_SINCE_HOURS` для режима immediate **не используются** — можно не указывать или оставить пустыми.

Сохраните файл.

### A.3. Где должен быть .env

- Если бот и **Robokassa работают на ВМ** (uvicorn robokassa_server): файл `.env` должен быть в рабочей папке службы Robokassa (указанной в `WorkingDirectory` в unit-файле, например `/home/enhel-method/tg-ai-enhel-method`). Именно сервер Robokassa при получении Result URL от Робокассы отправляет уведомление в чат.
- Отредактируйте `.env` на ВМ (например, по SSH: `nano ~/tg-ai-enhel-method/.env`).

### A.4. Перезапустить сервер Robokassa (на ВМ)

Чтобы он подхватил новые переменные:

```bash
sudo systemctl restart robokassa-server
```

Проверка:

```bash
sudo systemctl status robokassa-server
```

Должно быть `active (running)`.

### A.5. Проверка

1. Сделайте тестовую оплату групповых занятий (в тестовом режиме Робокассы — «Успешное проведение платежа»).
2. В чате с `TELEGRAM_GROUP_NOTIFY_CHAT_ID` должна появиться строка вида:  
   `Групповые (сразу): ДД.ММ.ГГГГ ЧЧ:ММ МСК | user_id ... | chat_id ... | Стандарт/VIP | ... ₽`

Если сообщение не пришло: проверьте, что `GROUP_DIGEST_MODE=immediate` без пробелов и опечаток, что chat_id верный (число, без кавычек), что служба `robokassa-server` перезапущена и что оплата действительно прошла (Result URL вызывается Робокассой).

---

## Часть B. Режим «по расписанию» (scheduled)

### B.1. Узнать chat_id чата

Так же, как в шагах A.1 (getUpdates по токену бота, смотреть `chat.id`).

### B.2. Прописать переменные в .env на ВМ

Откройте `.env` **на той же ВМ, где будет запускаться cron** (обычно та же, где бот и Robokassa).

Добавьте или измените:

```env
TELEGRAM_GROUP_NOTIFY_CHAT_ID=-123456789
GROUP_DIGEST_MODE=scheduled
GROUP_DIGEST_TIME_1=12:00
GROUP_DIGEST_TIME_2=16:00
GROUP_DIGEST_TIME_3=
GROUP_DIGEST_SINCE_HOURS=12
```

Пояснения:

- **TELEGRAM_GROUP_NOTIFY_CHAT_ID** — подставьте свой chat_id (число).
- **GROUP_DIGEST_MODE** — обязательно `scheduled` для этого режима.
- **GROUP_DIGEST_TIME_1**, **GROUP_DIGEST_TIME_2**, **GROUP_DIGEST_TIME_3** — время по Москве в формате `ЧЧ:ММ`. Можно указать одно, два или три времени. Пустое значение (как у `GROUP_DIGEST_TIME_3=` выше) значит «этот слот не использовать». Примеры:
  - Один раз в сутки в 14:00 МСК: `GROUP_DIGEST_TIME_1=14:00`, `GROUP_DIGEST_TIME_2=`, `GROUP_DIGEST_TIME_3=`.
  - Три раза: например `9:00`, `14:00`, `20:00`.
- **GROUP_DIGEST_SINCE_HOURS** — за сколько часов от момента запуска выбирать оплаты в сводку (по умолчанию 12). Можно не указывать — тогда будет 12.

Сохраните `.env`.

### B.3. Установить cron на ВМ

1. Подключитесь к ВМ по SSH (пользователь, в чьей домашней папке лежит проект).

2. Откройте crontab для редактирования (можно выполнить из любой папки на ВМ, не обязательно из папки проекта):

   ```bash
   crontab -e
   ```

   Если спросят редактор — выберите nano (обычно номер 1) и нажмите Enter.

3. В конец файла добавьте одну строку (подставьте свой путь к проекту и к python в venv):

   ```cron
   */10 * * * * cd C:\Users\AI_Art\telegram-ai-psychologist && /home/enhel-method/tg-ai-enhel-method/venv/bin/python send_group_digest.py
   ```

   Замените `/home/enhel-method/tg-ai-enhel-method` на фактический путь к папке с ботом (например `/home/ubuntu/tg-ai-enhel-method`). Путь к `python` должен вести к интерпретатору в виртуальном окружении этого проекта (`venv/bin/python`).

4. Сохраните и выйдите: в nano — `Ctrl+O`, Enter, затем `Ctrl+X`.

5. Проверить, что задание попало в crontab:

   ```bash
   crontab -l
   ```

   Должна быть строка с `send_group_digest.py`.

### B.4. Почему именно каждые 10 минут

Скрипт при каждом запуске смотрит текущее время по Москве. Отправка происходит **только если** текущие часы и минуты совпадают с одним из заданных в `GROUP_DIGEST_TIME_1/2/3`. Поэтому cron должен запускать скрипт хотя бы в ту минуту, когда наступило нужное время. Запуск каждые 10 минут (`*/10 * * * *`) гарантирует, что один из запусков попадёт, например, в 12:00 или 16:00 МСК.

### B.5. Проверка

1. Дождитесь одного из заданных времён (например 12:00 или 16:00 МСК) или временно поставьте время на ближайшие 1–2 минуты (например если сейчас 15:23 МСК, задайте `GROUP_DIGEST_TIME_1=15:25`, сохраните `.env`, подождите 2 минуты).
2. В указанный момент в чате должна появиться сводка: заголовок «Групповые занятия: оплаты за последние N ч» и таблица (или текст «За выбранный период оплат по групповым нет.»).
3. Если сообщение не пришло:
   - Проверьте время на сервере: `date` (должно быть UTC; 12:00 МСК = 09:00 UTC зимой).
   - Убедитесь, что в `.env` указан хотя бы один непустой `GROUP_DIGEST_TIME_1` (или _2, _3).
   - Проверьте логи cron (на Linux часто `grep CRON /var/log/syslog` или `journalctl -u cron -n 50`), что задание выполняется.
   - Запустите скрипт вручную в нужную минуту:  
     `cd ~/tg-ai-enhel-method && ./venv/bin/python send_group_digest.py`  
     — в консоли должно быть «Отправлено: N записей» или ошибка; по ней проще понять причину.

---

## Общие моменты

- **Один и тот же .env** используется и ботом, и сервером Robokassa, и скриптом дайджеста (при запуске из cron). Все переменные дайджеста должны быть в этом файле на ВМ.
- **TELEGRAM_BOT_TOKEN** — уже должен быть в `.env` для бота; его же использует дайджест для отправки в Telegram.
- **PAYMENTS_DB_PATH** — путь к SQLite-файлу с заказами. Должен быть один и тот же для Robokassa и для скрипта дайджеста, иначе сводка будет по другой базе.

После выполнения шагов для выбранного режима (A или B) дайджест по групповым занятиям будет работать в соответствии с настройками.
